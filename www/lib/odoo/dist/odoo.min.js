"use strict";angular.module("odoo",["ngCookies"]);
"use strict";angular.module("odoo").provider("jsonRpc",function(){this.odooRpc={odoo_server:"",uniq_id_counter:0,context:{lang:"fr_FR"},shouldManageSessionId:!1,errorInterceptors:[]};var e=null;this.$get=["$http","$cookies","$q","$timeout",function(t,n,o,r){var s=this.odooRpc;return s.login=function(e,t,r){var i={db:e,login:t,password:r};return s.sendRequest("/web/session/authenticate",i).then(function(e){return e.uid?(s.context=e.user_context,n.session_id=e.session_id,e):(delete n.session_id,o.reject({title:"wrong_login",message:"Credentials incorrect",fullTrace:e}))})},s.isLoggedIn=function(e){return e?s.getSessionInfo().then(function(e){return!!e.uid}):n.session_id&&n.session_id.length>10},s.logout=function(e){delete n.session_id,e&&s.getSessionInfo().then(function(e){e.db&&s.login(e.db,"","")})},s.searchRead=function(e,t,n){var o={model:e,domain:t,fields:n};return s.sendRequest("/web/dataset/search_read",o)},s.getSessionInfo=function(){return s.sendRequest("/web/session/get_session_info",{})},s.getServerInfo=function(){return s.sendRequest("/web/webclient/version_info",{})},s.syncDataImport=function(e,t,n,o,r){return s.call(e,"get_sync_data",[t,r.timekey,n,o],{}).then(function(i){r.timekey!==i.timekey&&(r.timekey=i.timekey,angular.forEach(i.remove_ids,function(e){delete r.data[e]}),Object.keys(i.data).length&&(angular.extend(r.data,i.data),s.syncDataImport(e,t,n,o,r)))})},s.syncImportObject=function(e){function t(){s.syncDataImport(e.model,e.func_key,e.domain,e.limit,i).then(function(){n||r(t,e.interval)}).then(function(){o.forEach(function(e){e(i)})})}var n=!1,o=[],i={data:{},timekey:null,stopCallback:function(){n=!0},watch:function(e){o.push(e)}};return t(),i},s.call=function(e,t,n,o){o=o||{},o.context=o.context||{},angular.extend(o.context,s.context);var r={model:e,method:t,args:n,kwargs:o};return s.sendRequest("/web/dataset/call_kw",r)},s.sendRequest=function(r,i){function a(e,t){s.uniq_id_counter+=1,s.shouldManageSessionId&&(t.session_id=n.session_id);var o={jsonrpc:"2.0",method:"call",params:t};return{method:"POST",url:s.odoo_server+e,data:JSON.stringify(o),headers:{"Content-Type":"application/json"},id:"r"+s.uniq_id_counter}}function u(e){if(!e.data.error)return e.data;var t=e.data.error,r={title:"",message:"",fullTrace:t};if(200===t.code&&"Odoo Server Error"===t.message&&"werkzeug.exceptions.NotFound"===t.data.name)r.title="page_not_found",r.message="HTTP Error";else if(100===t.code&&"Odoo Session Expired"===t.message||300===t.code&&"OpenERP WebClient Error"===t.message&&t.data.debug.match("SessionExpiredException"))r.title="session_expired",delete n.session_id;else{var i=(""+t.data.fault_code).split("\n")[0].split(" -- ");i.length>1&&(t.type=i.shift(),t.data.fault_code=t.data.fault_code.substr(t.type.length+4)),200===t.code&&t.type?(r.title=t.type,r.message=t.data.fault_code.replace(/\n/g,"<br />")):(r.title=t.message,r.message=t.data.debug.replace(/\n/g,"<br />"))}return s.errorInterceptors.forEach(function(e){e(r)}),o.reject(r)}function c(e){var t={title:"http",fullTrace:e,message:"HTTP Error"};return s.errorInterceptors.forEach(function(e){e(t)}),o.reject(t)}function d(e,n){var o=a(e,n);return t(o).then(u,c)}function l(){return e||d("/web/webclient/version_info",{}).then(function(t){s.shouldManageSessionId=t.result.server_serie<"8",e=o.when()})}return l().then(function(){return d(r,i).then(function(e){var n=[];return"ir.actions.act_proxy"===e.result.type?(angular.forEach(e.result.action_list,function(e){n.push(t.post(e.url,e.params))}),o.all(n)):e.result})})},s}]});